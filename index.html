<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rifa Gest√£o Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --bg-app: #f4f7f6; --color-res: #ffeb3b; --color-pago: #ff3d00; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-app); display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        .dashboard { width: 100%; max-width: 500px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); box-sizing: border-box; }
        .stat-card { text-align: center; }
        .stat-value { font-size: 20px; font-weight: bold; }
        .stat-label { font-size: 10px; text-transform: uppercase; color: #777; }
        header { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        #gear-btn { background: none; border: none; font-size: 22px; cursor: pointer; opacity: 0.6; }
        #admin-panel { display: none; background: #fff; padding: 20px; border-radius: 12px; border: 2px solid #007bff; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; width: 90%; max-width: 460px; }
        .control-group { margin: 12px 0; display: flex; flex-direction: column; gap: 5px; }
        input[type="text"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        #raffle-container { position: relative; width: 100%; max-width: 500px; background: #fff; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border-radius: 4px; overflow: hidden; line-height: 0; }
        #bg-image { width: 100%; height: auto; display: block; min-height: 400px; background: #ddd; }
        #grid-overlay { position: absolute; top: 46%; left: 50%; transform: translateX(-50%); width: 83%; height: 42%; display: grid; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(10, 1fr); gap: 2px; box-sizing: border-box; }
        .cell { background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 13px; cursor: pointer; user-select: none; }
        .cell.reserved { background: var(--color-res) !important; color: #000; }
        .cell.paid { background: var(--color-pago) !important; color: #fff; }
        #btn-capture { position: fixed; bottom: 20px; width: 90%; max-width: 400px; padding: 15px; border: none; border-radius: 30px; background: #25d366; color: white; font-weight: bold; font-size: 16px; cursor: pointer; box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4); z-index: 100; }
        .admin-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;}
        .btn-adm { padding:10px; border:none; border-radius:4px; cursor: pointer; font-weight: bold; font-size: 11px;}
    </style>
</head>
<body>

    <header>
        <div id="raffle-title" style="font-weight: bold; color: #333; font-size: 14px;">CARREGANDO...</div>
        <button id="gear-btn">‚öôÔ∏è</button>
    </header>

    <div class="dashboard">
        <div class="stat-card"><span class="stat-value" style="color:var(--color-pago)" id="count-paid">0</span><br><span class="stat-label">Pagos</span></div>
        <div class="stat-card"><span class="stat-value" style="color:#d4af37" id="count-res">0</span><br><span class="stat-label">Reservas</span></div>
        <div class="stat-card"><span class="stat-value" style="color:#2e7d32" id="count-disp">100</span><br><span class="stat-label">Livres</span></div>
    </div>

    <div id="admin-panel">
        <div class="control-group">
            <label>Link da Imagem Online:</label>
            <input type="text" id="img-url" placeholder="https://i.imgur.com/...">
        </div>
        <div class="control-group"><label>Posi√ß√£o Vertical (%): <span id="val-top">46</span></label><input type="range" id="adj-top" min="0" max="100" value="46"></div>
        <div class="control-group"><label>Largura (%): <span id="val-width">83</span></label><input type="range" id="adj-width" min="50" max="100" value="83"></div>
        <div class="control-group"><label>Altura (%): <span id="val-height">42</span></label><input type="range" id="adj-height" min="10" max="90" value="42"></div>
        <div class="admin-btns">
            <button class="btn-adm" id="btn-reset-numbers" style="background:#f44336; color:white; grid-column: span 2; margin-bottom:5px">üóëÔ∏è ZERAR DEZENAS</button>
            <button class="btn-adm" onclick="location.reload()" style="background:#666; color:white">FECHAR</button>
            <button class="btn-adm" id="btn-generate-link" style="background:#007bff; color:white">üîó GERAR LINK</button>
        </div>
    </div>

    <div id="raffle-container">
        <img id="bg-image" src="" alt="Fundo">
        <div id="grid-overlay"></div>
    </div>

    <button id="btn-capture">üì∏ Capturar e Enviar</button>

    <script>
        const PASS_ADMIN = "yw14ad8x";
        const grid = document.getElementById('grid-overlay');
        const bgImg = document.getElementById('bg-image');
        const adminPanel = document.getElementById('admin-panel');
        const imgUrlInput = document.getElementById('img-url');
        
        let currentRaffleID = "default";

        // Inicializa√ß√£o
        window.onload = function() {
            initGrid();
            const urlParams = new URLSearchParams(window.location.search);
            const configParam = urlParams.get('config');

            if (configParam) {
                try {
                    document.getElementById('gear-btn').style.display = 'none';
                    const config = JSON.parse(decodeURIComponent(atob(configParam)));
                    applyConfig(config);
                    currentRaffleID = btoa(config.img).substring(0, 16);
                } catch (e) { alert("Erro ao abrir link."); }
            } else {
                loadAdminConfig();
            }
            document.getElementById('raffle-title').innerText = "CONTROLE DE VENDAS";
            setTimeout(loadStates, 200);
        };

        function initGrid() {
            grid.innerHTML = "";
            for (let i = 1; i <= 100; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.textContent = i === 100 ? '00' : String(i).padStart(2, '0');
                cell.addEventListener('click', () => {
                    if (cell.classList.contains('paid')) cell.classList.remove('paid', 'reserved');
                    else if (cell.classList.contains('reserved')) { cell.classList.remove('reserved'); cell.classList.add('paid'); }
                    else cell.classList.add('reserved');
                    saveStates();
                    updateDashboard();
                });
                grid.appendChild(cell);
            }
        }

        function applyConfig(c) {
            bgImg.src = c.img;
            grid.style.top = c.top + '%';
            grid.style.width = c.width + '%';
            grid.style.height = c.height + '%';
        }

        function saveStates() {
            const states = Array.from(document.querySelectorAll('.cell')).map(c => c.classList.contains('paid') ? 2 : (c.classList.contains('reserved') ? 1 : 0));
            localStorage.setItem('raffle_v4_' + currentRaffleID, JSON.stringify(states));
        }

        function loadStates() {
            const saved = localStorage.getItem('raffle_v4_' + currentRaffleID);
            if(!saved) return;
            const states = JSON.parse(saved);
            const cells = document.querySelectorAll('.cell');
            states.forEach((s, i) => {
                if(s === 1) cells[i].classList.add('reserved');
                if(s === 2) cells[i].classList.add('paid');
            });
            updateDashboard();
        }

        document.getElementById('btn-generate-link').addEventListener('click', () => {
            const url = imgUrlInput.value;
            if(!url.startsWith('http')) return alert("Insira um link de imagem v√°lido!");
            const config = { img: url, top: document.getElementById('adj-top').value, width: document.getElementById('adj-width').value, height: document.getElementById('adj-height').value };
            const encoded = btoa(encodeURIComponent(JSON.stringify(config)));
            const finalLink = window.location.origin + window.location.pathname + "?config=" + encoded;
            
            // Copia e avisa
            const dummy = document.createElement("input");
            document.body.appendChild(dummy);
            dummy.value = finalLink;
            dummy.select();
            document.execCommand("copy");
            document.body.removeChild(dummy);
            alert("LINK GERADO! Como o link √© longo, recomendo usar o BITLY ou TINYURL para encurt√°-lo antes de enviar por e-mail ou WhatsApp.");
        });

        function updateDashboard() {
            const p = document.querySelectorAll('.cell.paid').length;
            const r = document.querySelectorAll('.cell.reserved').length;
            document.getElementById('count-paid').innerText = p;
            document.getElementById('count-res').innerText = r;
            document.getElementById('count-disp').innerText = 100 - p - r;
        }

        // Fun√ß√µes de Admin e Captura (mantidas)
        document.getElementById('gear-btn').onclick = () => { if(prompt("Senha:") === PASS_ADMIN) adminPanel.style.display="block"; };
        document.getElementById('btn-reset-numbers').onclick = () => { if(confirm("Zerar tudo?")) { document.querySelectorAll('.cell').forEach(c => c.classList.remove('paid','reserved')); saveStates(); updateDashboard(); } };
        document.getElementById('btn-capture').onclick = () => { html2canvas(document.getElementById('raffle-container'),{scale:2,useCORS:true}).then(canvas => { const a = document.createElement('a'); a.download='rifa.png'; a.href=canvas.toDataURL(); a.click(); }); };
        
        function loadAdminConfig() {
            const saved = localStorage.getItem('admin_setup');
            if(saved) {
                const d = JSON.parse(saved);
                imgUrlInput.value = d.img;
                applyConfig(d);
                currentRaffleID = btoa(d.img).substring(0,16);
            }
        }
        [document.getElementById('adj-top'), document.getElementById('adj-width'), document.getElementById('adj-height')].forEach(el => el.oninput = () => {
            document.getElementById('val-'+el.id.replace('adj-','')).innerText = el.value;
            const c = { img: imgUrlInput.value, top: document.getElementById('adj-top').value, width: document.getElementById('adj-width').value, height: document.getElementById('adj-height').value };
            applyConfig(c);
            localStorage.setItem('admin_setup', JSON.stringify(c));
        });
        imgUrlInput.onchange = () => { const c = { img: imgUrlInput.value, top: document.getElementById('adj-top').value, width: document.getElementById('adj-width').value, height: document.getElementById('adj-height').value }; applyConfig(c); localStorage.setItem('admin_setup', JSON.stringify(c)); location.reload(); };
    </script>
</body>
</html>